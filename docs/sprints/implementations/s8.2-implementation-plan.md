# S8.2 Implementation Plan: Audio Player Widget Integration

**Story**: S8.2 Audio Player Widget Integration (Consolidated with S8.7)  
**Status**: PENDING  
**Created**: December 20, 2025  
**Estimate**: 8-10 hours

---

## Story Summary

**User Story**: As a visitor viewing a release detail page, I want to listen to audio previews so that I can sample the music before purchasing or streaming.

**Consolidated Features** (S8.2 + S8.7):
- MP3 audio file storage on Dreamhost file system
- Client-side validation (file type, size, duration)
- Minimal audio player with speaker icon, progress bar, loop functionality
- Admin upload/management via release upsert form
- Conditional rendering (only shows if audio exists)

---

## Acceptance Criteria

1. ✓ Audio player widget displays on release detail pages when audio URL is configured
2. ✓ Player reads MP3 files from Dreamhost file system (not Spotify)
3. ✓ Player displays speaker icon with pulsing animation during playback, toggle on/off
4. ✓ Play/pause controls functional with visual feedback
5. ✓ Minimal progress bar displayed (time elapsed / total duration)
6. ✓ Responsive player design matches site theme (grunge aesthetic)
7. ✓ Admin can configure audio file per release in admin dashboard
8. ✓ Audio file upload field in release upsert form with validation
9. ✓ Player only renders if audio URL exists (conditional display)
10. ✓ Mobile-responsive player with touch-friendly controls
11. ✓ Audio loops/repeats when playback completes
12. ✓ Client-side validation: MP3 format, 2MB max size, 35 seconds max duration

---

## Architectural Directives

### Design Pattern Compliance

**Backend Patterns**:
- ✅ **Repository Pattern**: Direct PDO queries with parameterized SQL
- ✅ **Security Pattern**: `requireAuth()` for admin endpoints, file upload validation
- ✅ **Optional Field Pattern**: `audio_url` nullable, backward compatible (matches social media URLs)

**Frontend Patterns**:
- ✅ **Factory Pattern**: API service via `createServices().releases.uploadAudio()`
- ✅ **Component Pattern**: Reusable `AudioPlayer.tsx` component
- ✅ **Conditional Rendering**: Player only displays if `audio_url` exists
- ✅ **State Management**: Local `useState` for ephemeral UI state (playing, currentTime)
  - **Rationale**: Audio playback is component-level, not global app state
  - **No Zustand needed**: Player state doesn't need to persist across page navigation

**File Upload Patterns**:
- ✅ **Matches S3.5**: Follow `upload-cover-image.php` security and validation patterns
- ✅ **Client-Side Validation**: HTML5 Audio API for duration check before upload
- ✅ **Server-Side Validation**: MIME type, file extension, file size (no duration check)

---

## Implementation Increments

### Increment 1: Database Schema & Migration
**Duration**: 30 minutes  
**Acceptance Criteria**: Backend data structure  

**Tasks**:
1. Create migration file: `009_add_audio_url.sql`
2. Add column: `audio_url VARCHAR(500) NULL` to `releases` table
3. Add index: `INDEX idx_audio_url (audio_url)` for query optimization
4. Test migration on local database

**Files**:
- `backend/database/migrations/009_add_audio_url.sql` (NEW)

**SQL**:
```sql
ALTER TABLE releases ADD COLUMN audio_url VARCHAR(500) NULL;
CREATE INDEX idx_audio_url ON releases(audio_url);
```

**Validation**:
- Migration runs without errors
- Column appears in `releases` table
- Index created successfully

---

### Increment 2: Backend File Upload Endpoint
**Duration**: 2-3 hours  
**Acceptance Criteria**: AC #7, #8 (admin can upload audio files)

**Tasks**:
1. Create `upload-audio.php` endpoint
2. Implement authentication check (`requireAuth()`)
3. Validate file upload:
   - MIME type: `audio/mpeg`
   - File extension: `.mp3`
   - File size: 2MB max (2097152 bytes)
4. Store file with naming convention: `{release_id}_audio.mp3`
5. Environment-aware file storage:
   - Development: `/var/www/html/uploads/audio/`
   - Production: `/home/dh_9d47dc/alldayeverydayrecords.com/release-audio/`
6. Return audio URL in JSON response
7. Handle file replacement (delete old file if exists)

**Files**:
- `backend/api/upload-audio.php` (NEW)

**Pattern Reference**: `upload-cover-image.php` (lines 1-102)

**Key Code Patterns**:
```php
// Authentication
$user = requireAuth();

// Validation
$allowedTypes = ['audio/mpeg'];
$maxSize = 2 * 1024 * 1024; // 2MB

// File naming
$safeName = "{$releaseId}_audio.mp3";

// Environment-aware paths
$isDevelopment = $config['environment'] === 'development';
$uploadDir = $isDevelopment 
    ? '/var/www/html/uploads/audio/'
    : '/home/dh_9d47dc/alldayeverydayrecords.com/release-audio/';
```

**Validation**:
- Endpoint returns 401 without authentication
- Rejects non-MP3 files with 400 error
- Rejects files > 2MB with 400 error
- Successfully uploads valid MP3 file
- Returns correct audio URL in response

---

### Increment 3: Backend API Updates
**Duration**: 1-2 hours  
**Acceptance Criteria**: AC #7 (persist audio URL, return in API responses)

**Tasks**:
1. Update `upsert-release.php`:
   - Add `audio_url` to UPDATE query
   - Add `audio_url` to INSERT query
   - Handle NULL values using `?? null` pattern
2. Update `get-releases-by-id.php`:
   - Add `audio_url` to SELECT query
   - Return in JSON response
3. Update `get-releases.php`:
   - Add `audio_url` to admin query
   - Add `audio_url` to public query (if needed)

**Files**:
- `backend/api/upsert-release.php` (MODIFIED)
- `backend/api/get-releases-by-id.php` (MODIFIED)
- `backend/api/get-releases.php` (MODIFIED)

**Pattern Reference**: S8.3 social media URLs implementation

**Key Code Patterns**:
```php
// upsert-release.php UPDATE query
$audio_url = $_POST['audio_url'] ?? null;

$sql = "UPDATE releases SET 
    audio_url = ?, 
    ... 
WHERE id = ?";

$params = [$audio_url, ...];

// get-releases-by-id.php SELECT query
SELECT 
    id, title, artist, audio_url, ...
FROM releases 
WHERE id = ?
```

**Validation**:
- Create release with audio URL saves correctly
- Update release audio URL works
- GET endpoint returns audio URL
- NULL audio URLs handled properly

---

### Increment 4: Frontend AudioPlayer Component
**Duration**: 2-3 hours  
**Acceptance Criteria**: AC #1, #3, #4, #5, #6, #10, #11

**Tasks**:
1. Create `AudioPlayer.tsx` component
2. Implement UI:
   - Speaker icon (Material-UI `VolumeUp` icon)
   - Pulsing animation during playback (CSS keyframes)
   - Minimal progress bar (current time / total duration)
   - Play/pause toggle
3. Implement functionality:
   - HTML5 `<audio>` element with `loop` attribute
   - Play/pause control
   - Progress tracking with `ontimeupdate` event
   - Cleanup on unmount (pause audio)
4. Styling:
   - Match grunge theme
   - Responsive design (mobile/desktop)
   - Position near release title

**Files**:
- `frontend/src/components/AudioPlayer.tsx` (NEW)

**Component Interface**:
```typescript
interface AudioPlayerProps {
  audioUrl: string;
  artistName: string;
  releaseTitle: string;
}
```

**Key Features**:
```typescript
const [isPlaying, setIsPlaying] = useState(false);
const [currentTime, setCurrentTime] = useState(0);
const [duration, setDuration] = useState(0);
const audioRef = useRef<HTMLAudioElement>(null);

// Play/pause toggle
const togglePlay = () => {
  if (isPlaying) {
    audioRef.current?.pause();
  } else {
    audioRef.current?.play();
  }
};

// Progress tracking
useEffect(() => {
  const audio = audioRef.current;
  if (!audio) return;
  
  const handleTimeUpdate = () => setCurrentTime(audio.currentTime);
  const handleLoadedMetadata = () => setDuration(audio.duration);
  
  audio.addEventListener('timeupdate', handleTimeUpdate);
  audio.addEventListener('loadedmetadata', handleLoadedMetadata);
  
  return () => {
    audio.removeEventListener('timeupdate', handleTimeUpdate);
    audio.removeEventListener('loadedmetadata', handleLoadedMetadata);
  };
}, []);
```

**Animation CSS**:
```css
@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.7; transform: scale(1.1); }
}

.audio-icon-playing {
  animation: pulse 1.5s ease-in-out infinite;
}
```

**Validation**:
- Speaker icon displays correctly
- Click toggles play/pause
- Pulsing animation shows during playback
- Progress bar updates during playback
- Audio loops when track ends
- Component works on mobile/desktop

---

### Increment 5: Admin Form Integration
**Duration**: 2 hours  
**Acceptance Criteria**: AC #7, #8, #12

**Tasks**:
1. Add "Audio Preview" section to AdminDashboard release form
2. Add file input field with validation
3. Implement client-side validation:
   - File type: .mp3 only (check extension)
   - File size: 2MB max
   - Duration: 35 seconds max (HTML5 Audio API)
4. Display current audio filename if exists
5. Add "Delete Audio" button for existing files
6. Integrate with `uploadAudio()` API service
7. Update form submission to include audio URL

**Files**:
- `frontend/src/pages/AdminDashboard.tsx` (MODIFIED)
- `frontend/src/services/releaseService.ts` (MODIFIED - add `uploadAudio()`)
- `frontend/src/types/Release.ts` (MODIFIED - add `audio_url` field)

**Client-Side Duration Validation**:
```typescript
const validateAudioFile = (file: File): Promise<boolean> => {
  return new Promise((resolve) => {
    const audio = new Audio(URL.createObjectURL(file));
    audio.onloadedmetadata = () => {
      URL.revokeObjectURL(audio.src);
      if (audio.duration > 35) {
        alert('Audio must be 35 seconds or less');
        resolve(false);
      } else {
        resolve(true);
      }
    };
    audio.onerror = () => {
      URL.revokeObjectURL(audio.src);
      alert('Invalid audio file');
      resolve(false);
    };
  });
};

const handleAudioUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
  const file = event.target.files?.[0];
  if (!file) return;
  
  // Validate extension
  if (!file.name.toLowerCase().endsWith('.mp3')) {
    alert('Only MP3 files are allowed');
    return;
  }
  
  // Validate size
  if (file.size > 2 * 1024 * 1024) {
    alert('File size must be less than 2MB');
    return;
  }
  
  // Validate duration
  const isValid = await validateAudioFile(file);
  if (!isValid) return;
  
  // Upload file
  const audioUrl = await services.releases.uploadAudio(releaseId, file);
  // Update form state
};
```

**API Service Addition** (`releaseService.ts`):
```typescript
async uploadAudio(releaseId: number, file: File): Promise<string> {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('release_id', releaseId.toString());
  
  const response = await this.api.post('/upload-audio.php', formData, {
    headers: { 'Content-Type': 'multipart/form-data' }
  });
  
  return response.data.audio_url;
}
```

**Validation**:
- File input accepts .mp3 files only
- File size validation works (rejects > 2MB)
- Duration validation works (rejects > 35 seconds)
- Upload progress shows during upload
- Current filename displays for existing audio
- Delete button removes audio file

---

### Increment 6: ReleaseDetailPage Integration
**Duration**: 1 hour  
**Acceptance Criteria**: AC #1, #9, #10

**Tasks**:
1. Import `AudioPlayer` component
2. Add conditional rendering based on `audio_url` existence
3. Position player below release title, above streaming buttons
4. Update TypeScript types to include `audio_url`
5. Pass required props (audioUrl, artistName, releaseTitle)

**Files**:
- `frontend/src/pages/ReleaseDetailPage.tsx` (MODIFIED)
- `frontend/src/types/Release.ts` (MODIFIED)

**Integration Code**:
```tsx
// ReleaseDetailPage.tsx
import AudioPlayer from '../components/AudioPlayer';

// Inside component render
{state.release?.audio_url && (
  <Box sx={{ mb: 4 }}>
    <AudioPlayer 
      audioUrl={state.release.audio_url}
      artistName={state.release.artist}
      releaseTitle={state.release.title}
    />
  </Box>
)}

<StreamingLinkButtons release={state.release} />
```

**Type Updates** (`Release.ts`):
```typescript
export interface ReleaseWithDetails extends Release {
  audio_url?: string | null;
  // ... existing fields
}
```

**Validation**:
- Player displays when audio URL exists
- Player hidden when no audio URL
- Positioned correctly on page
- Works on mobile and desktop
- No console errors or warnings

---

## Testing Strategy

### Unit Testing
- AudioPlayer component: play/pause, progress tracking, loop functionality
- Client-side validation: file type, size, duration checks
- API service: uploadAudio() method

### Integration Testing
- Upload flow: Admin form → backend upload → database save → detail page display
- Delete flow: Remove audio → database update → detail page refresh
- Error handling: Invalid files, oversized files, network errors

### Manual Testing Checklist
- [ ] Upload MP3 file via admin form
- [ ] Verify file stored in correct directory
- [ ] Verify audio URL saved to database
- [ ] Verify player displays on release detail page
- [ ] Test play/pause toggle
- [ ] Test progress bar updates
- [ ] Test audio loops when complete
- [ ] Test pulsing animation during playback
- [ ] Test mobile responsive behavior
- [ ] Test file validation (wrong type, too large, too long)
- [ ] Test delete audio functionality
- [ ] Test replace audio functionality
- [ ] Test conditional rendering (no audio = no player)

---

## File Manifest

**Backend - Database**:
- `backend/database/migrations/009_add_audio_url.sql` (NEW)

**Backend - API**:
- `backend/api/upload-audio.php` (NEW)
- `backend/api/upsert-release.php` (MODIFIED)
- `backend/api/get-releases-by-id.php` (MODIFIED)
- `backend/api/get-releases.php` (MODIFIED)

**Frontend - Components**:
- `frontend/src/components/AudioPlayer.tsx` (NEW)

**Frontend - Pages**:
- `frontend/src/pages/AdminDashboard.tsx` (MODIFIED)
- `frontend/src/pages/ReleaseDetailPage.tsx` (MODIFIED)

**Frontend - Services & Types**:
- `frontend/src/services/releaseService.ts` (MODIFIED)
- `frontend/src/types/Release.ts` (MODIFIED)

**Total Files**: 9 (2 new, 7 modified)

---

## Risk Assessment

**Low Risk**:
- ✅ No new dependencies required
- ✅ Follows established file upload pattern (S3.5)
- ✅ Optional field (backward compatible)
- ✅ HTML5 audio API widely supported

**Medium Risk**:
- ⚠️ Client-side duration validation can be bypassed (mitigated: file size limit catches most issues)
- ⚠️ Audio file storage requires disk space management (mitigated: 2MB limit per file)

**Mitigation Strategies**:
- Server-side file size validation as backup
- Monitor disk usage on Dreamhost
- Document manual cleanup procedures if needed

---

## Success Criteria

- ✅ All 12 acceptance criteria met
- ✅ Audio player works on all major browsers (Chrome, Firefox, Safari, Edge)
- ✅ Mobile and desktop responsive
- ✅ No regressions in existing release management functionality
- ✅ Code passes design pattern compliance validation
- ✅ Documentation updated (README, requirements)

---

## Post-Implementation Tasks

1. Update sprint progress tracker
2. Update README.md with S8.2 completion
3. Mark S8.7 as consolidated/complete
4. Test audio upload on Dreamhost production environment
5. Verify file permissions on production upload directory
6. Document audio file management procedures for admins

---

**Plan Status**: READY FOR APPROVAL  
**Next Step**: Await approval to proceed with Increment 1
