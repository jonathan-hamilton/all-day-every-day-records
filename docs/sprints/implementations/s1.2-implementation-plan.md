# S1.2: Database Schema Design and Connection - Implementation Plan

## Story Overview

**Story ID:** S1.2  
**Title:** Database Schema Design and Connection  
**Priority:** High  
**Estimated Duration:** 3-4 hours  
**Dependencies:** S1.1 - PHP Backend API Foundation ✅

## Acceptance Criteria Summary

- ✅ MySQL/MariaDB database schema is designed and documented
- ✅ Database connection configuration supports environment-based settings
- ✅ Core tables are created: releases, artists, labels, streaming_links
- ✅ Database migrations system is implemented for schema changes
- ✅ Connection pooling and error handling is configured
- ✅ Database seeding capabilities are available for development data
- ✅ Backup and restore procedures are documented

## Technical Requirements

### Database Design Requirements
- Support releases with multiple artists and streaming services
- Include proper indexing for performance on search/filter operations
- Foreign key relationships and data integrity constraints
- Plan for future admin user authentication tables
- Normalize data to reduce redundancy while maintaining query performance

### Infrastructure Requirements
- Environment-based connection configuration
- Connection error handling and retry logic
- Database health checks integration with existing health system
- Migration system for schema versioning
- Seeding system for development and testing data

## Implementation Strategy

### Database Schema Design Philosophy

**Normalization Approach:**
- **3rd Normal Form (3NF)** for core entities to eliminate redundancy
- **Denormalization** where needed for performance (streaming link metadata)
- **Foreign Key Constraints** to maintain data integrity
- **Indexing Strategy** for common query patterns

**Entity Relationship Overview:**
```
Artists ←→ ReleaseArtists ←→ Releases
Releases → Labels
Releases ←→ StreamingLinks
```

## Implementation Increments

### Increment 1: Database Schema Design & Documentation
**Duration**: 45-60 minutes  
**Complexity**: Medium-High

**Functionality Added:**
- Design complete database schema with proper normalization
- Create detailed entity relationship documentation
- Define all table structures with proper data types
- Plan indexing strategy for performance optimization

**Deliverables:**
- `backend/database/schema.sql` - Complete database schema
- `backend/database/README.md` - Database documentation
- `docs/database-schema.md` - Detailed schema documentation

### Increment 2: Database Connection & Configuration
**Duration**: 30-45 minutes  
**Complexity**: Medium

**Functionality Added:**
- Database connection class with environment configuration
- Connection pooling and error handling
- Integration with existing Environment configuration
- Database health checks for monitoring

**Deliverables:**
- `backend/api/core/Database.php` - Database connection management
- `backend/api/config/database.php` - Database configuration
- Enhanced HealthService with database connectivity checks

### Increment 3: Migration System Implementation
**Duration**: 45-60 minutes  
**Complexity**: Medium

**Functionality Added:**
- Database migration framework for schema versioning
- Migration runner with rollback capabilities
- Initial migration for core schema creation
- Migration status tracking

**Deliverables:**
- `backend/database/migrations/` - Migration files directory
- `backend/api/core/Migration.php` - Migration framework
- `backend/scripts/migrate.php` - Migration runner script
- Initial migrations for core tables

### Increment 4: Models & Data Access Layer
**Duration**: 60-75 minutes  
**Complexity**: High

**Functionality Added:**
- Base model class with common functionality
- Release, Artist, Label, StreamingLink models
- CRUD operations for all entities
- Model relationships and data validation

**Deliverables:**
- `backend/api/models/BaseModel.php` - Base model foundation
- `backend/api/models/Release.php` - Release model with relationships
- `backend/api/models/Artist.php` - Artist model
- `backend/api/models/Label.php` - Label model
- `backend/api/models/StreamingLink.php` - Streaming link model

### Increment 5: Data Seeding & Testing
**Duration**: 30-45 minutes  
**Complexity**: Low-Medium

**Functionality Added:**
- Database seeding system for development data
- Sample data creation for releases, artists, labels
- Testing utilities for database operations
- Database backup and restore documentation

**Deliverables:**
- `backend/database/seeders/` - Seeder files directory
- `backend/scripts/seed.php` - Seeding runner script
- Sample data for testing and development
- `backend/database/BACKUP.md` - Backup procedures documentation

## Database Schema Design

### Core Tables Structure

#### 1. Artists Table
```sql
CREATE TABLE artists (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE NOT NULL,
    bio TEXT DEFAULT NULL,
    image_url VARCHAR(500) DEFAULT NULL,
    website_url VARCHAR(500) DEFAULT NULL,
    social_media JSON DEFAULT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_slug (slug),
    INDEX idx_name (name)
);
```

#### 2. Labels Table
```sql
CREATE TABLE labels (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE NOT NULL,
    description TEXT DEFAULT NULL,
    website_url VARCHAR(500) DEFAULT NULL,
    logo_url VARCHAR(500) DEFAULT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_slug (slug),
    INDEX idx_name (name)
);
```

#### 3. Releases Table
```sql
CREATE TABLE releases (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE NOT NULL,
    description TEXT DEFAULT NULL,
    release_date DATE DEFAULT NULL,
    release_type ENUM('single', 'ep', 'album', 'compilation', 'mixtape') NOT NULL DEFAULT 'single',
    catalog_number VARCHAR(100) DEFAULT NULL,
    label_id INT UNSIGNED DEFAULT NULL,
    cover_image_url VARCHAR(500) DEFAULT NULL,
    bandcamp_url VARCHAR(500) DEFAULT NULL,
    is_featured BOOLEAN DEFAULT FALSE,
    display_order INT DEFAULT 0,
    status ENUM('draft', 'published', 'archived') DEFAULT 'published',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (label_id) REFERENCES labels(id) ON DELETE SET NULL,
    INDEX idx_slug (slug),
    INDEX idx_release_date (release_date),
    INDEX idx_release_type (release_type),
    INDEX idx_is_featured (is_featured),
    INDEX idx_status (status),
    INDEX idx_display_order (display_order)
);
```

#### 4. Release Artists Table (Many-to-Many)
```sql
CREATE TABLE release_artists (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    release_id INT UNSIGNED NOT NULL,
    artist_id INT UNSIGNED NOT NULL,
    role ENUM('primary', 'featured', 'remixer', 'producer') DEFAULT 'primary',
    display_order INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (release_id) REFERENCES releases(id) ON DELETE CASCADE,
    FOREIGN KEY (artist_id) REFERENCES artists(id) ON DELETE CASCADE,
    UNIQUE KEY unique_release_artist_role (release_id, artist_id, role),
    INDEX idx_release_id (release_id),
    INDEX idx_artist_id (artist_id),
    INDEX idx_role (role)
);
```

#### 5. Streaming Links Table
```sql
CREATE TABLE streaming_links (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    release_id INT UNSIGNED NOT NULL,
    platform VARCHAR(50) NOT NULL,
    url VARCHAR(500) NOT NULL,
    platform_release_id VARCHAR(255) DEFAULT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (release_id) REFERENCES releases(id) ON DELETE CASCADE,
    INDEX idx_release_id (release_id),
    INDEX idx_platform (platform),
    INDEX idx_is_active (is_active)
);
```

### Database Schema Rationale

**Design Decisions:**
1. **Normalized Structure**: Separates entities to reduce redundancy and improve data integrity
2. **Flexible Artist Relationships**: Many-to-many with roles supports complex collaborations
3. **Streaming Platform Agnostic**: Generic streaming_links table supports any platform
4. **SEO-Friendly**: Slug fields for all main entities enable clean URLs
5. **Admin Features Ready**: Status fields and display ordering for content management
6. **Performance Optimized**: Proper indexing on commonly queried fields

## Technical Implementation Details

### Database Connection Strategy
- **PDO with prepared statements** for security and performance
- **Connection pooling** through persistent connections
- **Automatic reconnection** handling for long-running processes
- **Environment-based configuration** for development/production

### Migration System Features
- **Version tracking** with migrations table
- **Rollback capabilities** for safe schema changes
- **Dependency management** for migration ordering
- **Environment-specific migrations** where needed

### Model Architecture
- **Active Record pattern** for intuitive data manipulation
- **Relationship methods** for easy data access
- **Validation layer** with custom rules
- **Event system** for model lifecycle hooks

## Testing Strategy

### Database Testing Approach
1. **Schema Validation**: Verify all tables, indexes, and constraints
2. **Connection Testing**: Test all environment configurations
3. **Migration Testing**: Verify migration up/down operations
4. **Model Testing**: Test CRUD operations and relationships
5. **Performance Testing**: Verify query performance with sample data

### Test Data Strategy
- **Realistic Sample Data**: Music releases from various genres
- **Relationship Testing**: Complex artist collaborations
- **Edge Cases**: Long titles, special characters, missing data
- **Volume Testing**: Sufficient data for pagination and search testing

## Success Criteria

### Functional Requirements
- All core tables created with proper relationships
- Database connection works in all environments
- Migrations execute successfully up and down
- Models perform CRUD operations correctly
- Sample data seeds populate realistic content

### Performance Requirements
- Database connection establishes within 1 second
- Basic queries execute within 100ms
- Migration execution completes within 30 seconds
- Model operations handle 1000+ records efficiently

### Integration Requirements
- Health checks report database connectivity
- Environment configuration switches between dev/production
- Error handling provides meaningful messages
- Backup procedures documented and tested

## Risk Mitigation

### Technical Risks
- **Schema Changes**: Migration system handles schema evolution safely
- **Connection Failures**: Retry logic and graceful degradation
- **Data Integrity**: Foreign key constraints prevent orphaned records
- **Performance**: Proper indexing and query optimization

### Development Risks
- **Environment Setup**: Clear documentation and validation scripts
- **Data Loss**: Backup procedures and rollback capabilities
- **Complex Relationships**: Well-documented model relationships

## Foundation for S1.3

S1.2 completion provides the following for S1.3 Frontend-Backend Integration:
- **API Endpoints**: Models enable full CRUD API implementation
- **Data Persistence**: Frontend forms can save actual data
- **Realistic Testing**: Seeded data enables meaningful frontend testing
- **Error Scenarios**: Database errors can be handled by frontend
- **Performance Validation**: Real queries enable frontend optimization

The database foundation enables immediate implementation of:
- Release listing and detail endpoints
- Artist and label information APIs
- Streaming link management
- Admin content management preparation