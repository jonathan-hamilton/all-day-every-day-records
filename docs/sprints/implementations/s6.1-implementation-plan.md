# S6.1 Implementation Plan: Discography Database & Categorization System

**Story**: S6.1 - Discography Database & Categorization System  
**Sprint**: 6  
**Priority**: HIGH  
**Estimate**: 4-6 hours  
**Status**: IN PROGRESS  
**Date**: December 13, 2025

## Story Summary

Implement a dual categorization system for releases by adding boolean flags to the database that control whether releases appear in the Releases section, Discography section, or both. This extends the existing releases table with categorization columns, updates the API to support category-based filtering, and updates TypeScript types for type safety.

## Acceptance Criteria

1. ✅ Database migration adds `show_in_releases` and `show_in_discography` boolean flags to releases table
2. ✅ Both flags default to TRUE for backward compatibility with existing releases
3. ✅ GET endpoint `/get-releases.php` accepts optional `category` parameter ('releases', 'discography', or 'all')
4. ✅ API filters releases based on categorization flags when category parameter provided
5. ✅ TypeScript ReleaseOverview interface updated with categorization flags
6. ✅ Database indexes added on categorization columns for query performance
7. ✅ Existing releases automatically flagged as show_in_releases=TRUE, show_in_discography=FALSE
8. ✅ API maintains backward compatibility when no category filter specified

## Dependencies

### Existing Infrastructure (from Sprint 2 & 3)
- ✅ `backend/api/get-releases.php` - Existing releases endpoint to extend
- ✅ `backend/database/schema.sql` - Releases table structure
- ✅ `frontend/src/types/Release.ts` - TypeScript release interfaces
- ✅ Database migration pattern from Sprint 5 (videos table)

### New Dependencies
- None - Uses existing technology stack

## Technical Architecture

### Database Schema Changes
```sql
-- Add categorization columns
ALTER TABLE releases 
ADD COLUMN show_in_releases BOOLEAN DEFAULT TRUE,
ADD COLUMN show_in_discography BOOLEAN DEFAULT FALSE;

-- Add composite index for filtering performance
CREATE INDEX idx_releases_categorization 
ON releases(show_in_releases, show_in_discography);

-- Update existing releases (default behavior)
UPDATE releases 
SET show_in_releases = TRUE, show_in_discography = FALSE 
WHERE show_in_releases IS NULL OR show_in_discography IS NULL;
```

### API Parameter Extension
```php
// get-releases.php accepts optional category parameter
$category = $_GET['category'] ?? null; // 'releases', 'discography', or 'all'

// Filter logic based on category
if ($category === 'releases') {
    $query .= " AND show_in_releases = 1";
} elseif ($category === 'discography') {
    $query .= " AND show_in_discography = 1";
}
// If $category is null or 'all', no additional filtering (backward compatible)
```

### TypeScript Type Updates
```typescript
export interface ReleaseOverview {
  id: number;
  title: string;
  artists_with_roles: string;
  release_date: string;
  release_type: string;
  cover_image_url: string;
  featured: boolean;
  recent: boolean;
  showInReleases: boolean;      // NEW
  showInDiscography: boolean;   // NEW
}
```

## Implementation Increments

### Increment 1: Database Migration
**Goal**: Add categorization columns and indexes to releases table

**Files Created**:
- `backend/database/migrations/006_add_discography_categorization.sql`

**Changes**:
1. Create migration file following Sprint 5 pattern
2. Add `show_in_releases BOOLEAN DEFAULT TRUE` column
3. Add `show_in_discography BOOLEAN DEFAULT FALSE` column
4. Create composite index on (show_in_releases, show_in_discography)
5. Update existing releases to show_in_releases=TRUE, show_in_discography=FALSE
6. Add comments explaining dual categorization purpose

**Validation**:
- Migration file syntax is valid SQL
- Defaults ensure backward compatibility
- Index optimizes category filtering queries
- Existing releases maintain current behavior (Releases-only)

---

### Increment 2: TypeScript Type Updates
**Goal**: Update Release interfaces with categorization flags

**Files Modified**:
- `frontend/src/types/Release.ts`

**Changes**:
1. Add `showInReleases: boolean` to ReleaseOverview interface
2. Add `showInDiscography: boolean` to ReleaseOverview interface
3. Follow existing camelCase naming convention
4. Maintain alphabetical field ordering for consistency

**Validation**:
- TypeScript compilation succeeds
- No type errors in existing components
- Fields follow project naming conventions

---

### Increment 3: API Category Parameter Support
**Goal**: Add category filtering to get-releases.php endpoint

**Files Modified**:
- `backend/api/get-releases.php`

**Changes**:
1. Accept optional `category` query parameter
2. Validate category value ('releases', 'discography', 'all', or null)
3. Add WHERE clause filtering based on category:
   - 'releases': `show_in_releases = 1`
   - 'discography': `show_in_discography = 1`
   - 'all' or null: no additional filtering (backward compatible)
4. Include show_in_releases and show_in_discography in SELECT statement
5. Map database fields to camelCase in JSON response

**Validation**:
- API returns correct releases for each category parameter
- Backward compatibility: no category parameter returns all published releases
- Response includes showInReleases and showInDiscography fields
- SQL queries use composite index efficiently

## Testing Strategy

### Manual Testing Checklist

**Database Migration**:
- [ ] Migration executes without errors
- [ ] Columns added with correct data types and defaults
- [ ] Index created successfully
- [ ] Existing releases updated correctly

**API Endpoint**:
- [ ] `/get-releases.php` returns all releases (no category parameter)
- [ ] `/get-releases.php?category=releases` returns only releases with show_in_releases=1
- [ ] `/get-releases.php?category=discography` returns only releases with show_in_discography=1
- [ ] `/get-releases.php?category=all` returns all releases
- [ ] Response includes showInReleases and showInDiscography fields
- [ ] Invalid category values handled gracefully

**TypeScript Types**:
- [ ] TypeScript compilation succeeds
- [ ] No type errors in Releases page
- [ ] No type errors in service layer

## Migration Execution

### Running the Migration

**Option 1: Direct MySQL Execution**
```bash
mysql -u username -p database_name < backend/database/migrations/006_add_discography_categorization.sql
```

**Option 2: Via phpMyAdmin**
1. Open phpMyAdmin
2. Select database
3. Go to SQL tab
4. Paste migration file contents
5. Execute

**Option 3: PHP Script** (if migration runner exists)
```bash
php backend/database/run-migration.php 006
```

### Verification Queries

**Check columns exist:**
```sql
DESCRIBE releases;
```

**Check index exists:**
```sql
SHOW INDEX FROM releases WHERE Key_name = 'idx_releases_categorization';
```

**Check existing releases updated:**
```sql
SELECT id, title, show_in_releases, show_in_discography FROM releases LIMIT 10;
```

## Rollback Plan

If issues arise, rollback with:

```sql
-- Remove index
DROP INDEX idx_releases_categorization ON releases;

-- Remove columns
ALTER TABLE releases 
DROP COLUMN show_in_releases,
DROP COLUMN show_in_discography;
```

## Risk Assessment

**LOW RISK** - This story:
- Extends existing table without modifying current columns
- Uses DEFAULT values for backward compatibility
- API parameter is optional (maintains existing behavior)
- No frontend UI changes (preparation for S6.2 and S6.3)

Potential Issues:
- Migration execution permissions (mitigated by standard MySQL privileges)
- Index size on large tables (mitigated by composite index on boolean columns)
- API parameter validation (mitigated by explicit value checking)

## Success Criteria

S6.1 is complete when:
1. ✅ Database migration executed successfully
2. ✅ Categorization columns exist with correct defaults
3. ✅ Composite index created for performance
4. ✅ Existing releases updated to show_in_releases=TRUE, show_in_discography=FALSE
5. ✅ API accepts and filters by category parameter
6. ✅ API maintains backward compatibility (no parameter = all releases)
7. ✅ TypeScript types updated and compilation succeeds
8. ✅ Manual testing checklist completed
9. ✅ No errors in browser console or PHP error logs

---

**Next Steps After S6.1**:
- S6.2: Create Discography page using category parameter
- S6.3: Add admin checkbox controls for categorization
- Update README.md and sprint documentation
- Run update-commit workflow

## Architectural Directives

### Design Pattern Compliance

**Service Layer Pattern (Backend)**:
- ✅ Database logic contained in get-releases.php
- ✅ Query building follows existing pattern
- ✅ Response formatting consistent with existing endpoints

**Factory Pattern (Frontend)**:
- ✅ TypeScript types used by existing service factory
- ✅ No changes needed to createServices() factory
- ✅ Type updates transparent to service consumers

**Migration Pattern**:
- ✅ Follows Sprint 5 migration structure (005_create_videos_table.sql)
- ✅ Uses ALTER TABLE for schema changes
- ✅ Includes indexes for performance
- ✅ Updates existing data for consistency

### State Management Strategy
- **N/A** - Backend-only changes with type updates
- No React state management needed
- Data flows through existing API service factory pattern

### Security Considerations
- **Input Validation**: Category parameter validated against allowed values
- **SQL Injection**: Parameter used in prepared statements or properly escaped
- **Backward Compatibility**: No breaking changes to existing API consumers
