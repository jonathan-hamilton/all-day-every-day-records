# S5.2 Implementation Plan: Videos Database & API Implementation

**Story**: S5.2 - Videos Database & API Implementation  
**Priority**: HIGH  
**Estimate**: 6-8 hours  
**Status**: IN PROGRESS

---

## Story Overview

**User Story**: As a system administrator, I want a separate videos database table and API endpoints so that video content can be managed independently from homepage videos.

**Acceptance Criteria**:
1. Videos table created in database with schema: id, title, youtube_url, description, artist, created_at, updated_at
2. GET endpoint `/get-videos.php` returns all published videos sorted by artist, then title
3. GET endpoint `/get-video-by-id.php?id=X` returns single video details + related videos by artist
4. POST endpoint `/upsert-video.php` creates or updates video records (admin auth required)
5. DELETE endpoint `/delete-video.php` removes video records (admin auth required)
6. All endpoints return proper JSON responses with success/error status
7. TypeScript interface `Video` created in `frontend/src/types/`
8. VideoDetail page created following ReleaseDetailPage pattern
9. VideoDetail displays embedded YouTube video at top (replaces cover image)
10. "More from [Artist]..." section shows other videos by same artist (excludes current video)
11. Videos page updated to fetch from new `/get-videos.php` endpoint
12. Clicking video from Videos page navigates to VideoDetail page

---

## Architectural Directives & Pattern Compliance

### üèóÔ∏è MANDATORY Design Patterns

#### 1. Factory Pattern - API Services ‚úÖ
- **Requirement**: ALL API service access MUST use `createServices()` factory
- **Implementation**: 
  - Create `VideoService` class following `ReleaseService` pattern
  - Add video service to factory in `services/index.ts`
  - Export `createVideoService()` factory function
- **Validation**: NO direct VideoService imports in components

#### 2. Component Architecture Pattern ‚úÖ
- **Requirement**: TypeScript interfaces for all props, React.FC type annotation
- **Implementation**:
  - `VideoDetailPage` component with TypeScript interfaces
  - Material-UI components for consistent design
  - Named and default exports
- **Validation**: All components have typed props

#### 3. State Management Pattern ‚úÖ
- **Requirement**: `useState` for local UI state only
- **Implementation**:
  - `useState` for loading, error, video data states
  - NO global state needed (all page-specific)
- **Validation**: No app state in component useState

#### 4. API Integration Pattern ‚úÖ
- **Requirement**: Follow existing backend API patterns
- **Implementation**:
  - Follow `get-releases.php` and `get-releases-by-id.php` patterns
  - Use `security.php` for authentication
  - Return consistent JSON response format
- **Validation**: All endpoints follow established patterns

#### 5. Database Pattern ‚úÖ
- **Requirement**: Use migration files, proper indexing
- **Implementation**:
  - Sequential migration: `005_create_videos_table.sql`
  - Indexes on artist for performance
  - Consistent with releases table patterns
- **Validation**: Migration follows existing format

---

## Technical Approach

### Database Schema

**Table**: `videos`

```sql
CREATE TABLE videos (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL COMMENT 'Video title',
    youtube_url VARCHAR(500) NOT NULL COMMENT 'Full YouTube video URL',
    description TEXT DEFAULT NULL COMMENT 'Video description',
    artist VARCHAR(255) NOT NULL COMMENT 'Artist name',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- Indexes for performance
    INDEX idx_artist (artist),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='Video content separate from homepage videos';
```

**Rationale**:
- Separate from `homepage_videos` for independent management
- Similar structure to `releases` table for consistency
- Artist field enables "More from [Artist]..." functionality
- No `display_order` or `is_published` - all videos in table are published
- No `thumbnail_url` - YouTube provides thumbnails via their API

---

### API Endpoints Specification

#### 1. GET `/get-videos.php`
**Purpose**: Retrieve all published videos  
**Authentication**: Public (no auth required)  
**Query Parameters**: None  
**Response**:
```json
{
  "success": true,
  "videos": [
    {
      "id": 1,
      "title": "Video Title",
      "youtube_url": "https://youtube.com/watch?v=...",
      "description": "Video description",
      "artist": "Artist Name",
      "created_at": "2025-12-13 10:00:00",
      "updated_at": "2025-12-13 10:00:00"
    }
  ]
}
```
**Sorting**: ORDER BY artist ASC, title ASC

#### 2. GET `/get-video-by-id.php?id=X`
**Purpose**: Retrieve single video with related videos by artist  
**Authentication**: Public (no auth required)  
**Query Parameters**: `id` (required)  
**Response**:
```json
{
  "success": true,
  "video": {
    "id": 1,
    "title": "Video Title",
    "youtube_url": "https://youtube.com/watch?v=...",
    "description": "Video description",
    "artist": "Artist Name",
    "created_at": "2025-12-13 10:00:00",
    "updated_at": "2025-12-13 10:00:00"
  },
  "relatedVideos": [
    { /* other videos by same artist, excluding current video */ }
  ]
}
```

#### 3. POST `/upsert-video.php`
**Purpose**: Create or update video record  
**Authentication**: Admin required (`requireAuth()`)  
**Request Body**:
```json
{
  "id": 1,  // Optional - omit for create, include for update
  "title": "Video Title",
  "youtube_url": "https://youtube.com/watch?v=...",
  "description": "Video description",
  "artist": "Artist Name"
}
```
**Response**:
```json
{
  "success": true,
  "message": "Video created successfully",
  "video_id": 1
}
```

#### 4. DELETE `/delete-video.php`
**Purpose**: Remove video record  
**Authentication**: Admin required (`requireAuth()`)  
**Request Body**:
```json
{
  "id": 1
}
```
**Response**:
```json
{
  "success": true,
  "message": "Video deleted successfully"
}
```

---

### TypeScript Types

**File**: `frontend/src/types/Video.ts`

```typescript
/**
 * Video content type for standalone Videos system
 */
export interface Video {
  id: number;
  title: string;
  youtube_url: string;
  description: string | null;
  artist: string;
  created_at: string;
  updated_at: string;
}

/**
 * Video detail response with related videos
 */
export interface VideoWithRelated {
  video: Video;
  relatedVideos: Video[];
}
```

---

### Frontend Service Layer

**File**: `frontend/src/services/videoService.ts`

**Methods**:
- `getVideos()`: Fetch all videos
- `getVideoById(id: number)`: Fetch single video with related videos
- `upsertVideo(videoData)`: Create/update video (admin)
- `deleteVideo(id: number)`: Delete video (admin)

**Pattern**: Follow `ReleaseService` structure exactly

---

### Component Architecture

#### VideoDetailPage Component

**File**: `frontend/src/pages/VideoDetailPage.tsx`

**Structure** (following ReleaseDetailPage pattern):
1. **Top Section**: Embedded YouTube video (replaces cover image)
2. **Metadata Section**: Title, artist, description
3. **Related Videos Section**: "More from [Artist]..." (if available)
4. **Navigation**: Back button

**State Management**:
```typescript
interface VideoDetailPageState {
  loading: boolean;
  error: string | null;
  video: Video | null;
  relatedVideos: Video[];
}
```

**Key Differences from ReleaseDetailPage**:
- YouTube embed at top instead of cover image
- Simpler metadata (no streaming links, release date, etc.)
- Related videos by artist instead of "Related Releases"

---

## Implementation Increments

### Increment 1: Database Schema & Migration ‚úÖ
**Files**:
- NEW: `backend/database/migrations/005_create_videos_table.sql`

**Tasks**:
1. Create migration file with sequential number (005)
2. Define videos table schema
3. Add appropriate indexes
4. Include DROP TABLE IF EXISTS for clean recreation
5. Follow existing migration file format

**Acceptance Criteria Met**: #1

---

### Increment 2: Backend API Endpoints ‚úÖ
**Files**:
- NEW: `backend/api/get-videos.php`
- NEW: `backend/api/get-video-by-id.php`
- NEW: `backend/api/upsert-video.php`
- NEW: `backend/api/delete-video.php`

**Tasks**:
1. Create get-videos.php (public, sorted by artist/title)
2. Create get-video-by-id.php (public, includes related videos)
3. Create upsert-video.php (admin auth required)
4. Create delete-video.php (admin auth required)
5. Follow existing API patterns from releases endpoints
6. Use security.php for authentication
7. Return consistent JSON response format

**Acceptance Criteria Met**: #2, #3, #4, #5, #6

---

### Increment 3: TypeScript Types & Service Layer ‚úÖ
**Files**:
- NEW: `frontend/src/types/Video.ts`
- MODIFIED: `frontend/src/types/index.ts`
- NEW: `frontend/src/services/videoService.ts`
- MODIFIED: `frontend/src/services/index.ts`

**Tasks**:
1. Create Video type interface
2. Export Video from types/index.ts
3. Create VideoService class following ReleaseService pattern
4. Implement service methods (getVideos, getVideoById, upsert, delete)
5. Add createVideoService factory function
6. Update services/index.ts to include videos in createServices()

**Acceptance Criteria Met**: #7

---

### Increment 4: VideoDetail Page Component ‚úÖ
**Files**:
- NEW: `frontend/src/pages/VideoDetailPage.tsx`
- MODIFIED: `frontend/src/pages/index.ts`
- MODIFIED: `frontend/src/App.tsx`

**Tasks**:
1. Create VideoDetailPage component
2. Follow ReleaseDetailPage structure
3. Display YouTube embed at top
4. Show video metadata (title, artist, description)
5. Implement "More from [Artist]..." section (exclude current video)
6. Add route `/videos/:id` in App.tsx
7. Export from pages/index.ts
8. Use Factory pattern for API calls
9. Implement loading, error, and success states

**Acceptance Criteria Met**: #8, #9, #10

---

### Increment 5: Update Videos Page to Use New API ‚úÖ
**Files**:
- MODIFIED: `frontend/src/pages/Videos.tsx`
- MODIFIED: `frontend/src/components/VideoGridItem.tsx`

**Tasks**:
1. Update Videos.tsx to use services.videos.getVideos()
2. Remove temporary homepage videos endpoint usage
3. Verify sorting (by artist, then title)
4. Update VideoGridItem to navigate to `/videos/:id` on click
5. Test click behavior navigates to VideoDetail page

**Acceptance Criteria Met**: #11, #12

---

## Testing & Validation

### Manual Testing Checklist

**Database**:
- [ ] Migration runs successfully
- [ ] Videos table created with correct schema
- [ ] Indexes exist on artist column

**API Endpoints**:
- [ ] GET /get-videos.php returns all videos sorted correctly
- [ ] GET /get-video-by-id.php returns video + related videos
- [ ] Related videos exclude current video
- [ ] POST /upsert-video.php creates new video (admin only)
- [ ] POST /upsert-video.php updates existing video (admin only)
- [ ] DELETE /delete-video.php removes video (admin only)
- [ ] Auth required for upsert/delete endpoints
- [ ] All endpoints return proper JSON format

**Frontend**:
- [ ] Videos page fetches from new endpoint
- [ ] Videos sorted by artist, then title
- [ ] Clicking video navigates to VideoDetail page
- [ ] VideoDetail displays YouTube embed
- [ ] VideoDetail shows video metadata
- [ ] "More from [Artist]..." section appears (when applicable)
- [ ] "More from [Artist]..." excludes current video
- [ ] "More from [Artist]..." hidden when no related videos
- [ ] Loading states work correctly
- [ ] Error states display properly
- [ ] Back navigation functions

**Pattern Compliance**:
- [ ] VideoService uses Factory pattern
- [ ] Components use TypeScript interfaces
- [ ] API calls through createServices()
- [ ] NO direct service imports in components
- [ ] State management uses useState only

---

## Dependencies

**Story Dependencies**:
- S5.1 (Videos Page & Navigation) - COMPLETE ‚úÖ

**External Dependencies**:
- Existing releases API patterns
- Existing security.php authentication
- Existing database connection (database.php)
- Material-UI components
- React Router for navigation

---

## Risk Assessment

**Low Risk**:
- Database migration (follows existing patterns)
- API endpoints (well-established patterns)
- TypeScript types (straightforward definitions)

**Medium Risk**:
- VideoDetail page complexity (mitigated by following ReleaseDetail pattern)
- Related videos query performance (mitigated by artist index)

**Mitigation Strategies**:
- Follow existing patterns closely
- Test each increment before proceeding
- Use indexes for query performance
- Reuse existing components where possible

---

## Success Criteria

**Functional**:
- ‚úÖ Videos table exists with proper schema
- ‚úÖ All API endpoints functional and secured appropriately
- ‚úÖ Videos page uses new endpoint
- ‚úÖ VideoDetail page displays correctly
- ‚úÖ Related videos feature works

**Technical**:
- ‚úÖ Design patterns properly applied
- ‚úÖ TypeScript type safety maintained
- ‚úÖ API responses consistent with existing format
- ‚úÖ Performance acceptable with proper indexing

**User Experience**:
- ‚úÖ Videos sorted alphabetically by artist/title
- ‚úÖ Navigation flows work correctly
- ‚úÖ Loading and error states provide feedback
- ‚úÖ Related videos enhance content discovery

---

## Notes

- Migration number 005 follows sequential pattern
- VideoDetail is simpler than ReleaseDetail (fewer metadata fields)
- No A-Z navigation widget in this story (deferred to Sprint 7)
- Homepage videos remain unchanged (separate system)
- Admin interface for video management is S5.3 (next story)
